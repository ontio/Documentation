# 分片共识管理测试用例

分片运行后，会像现有的主链一样进行周期性共识切换。每隔配置分片时设置的“max_block_change_view”个块切换一次共识。

为方便测试，可以在分片配置的时候，将max_block_change_view配置的小一点，这样等待分片周期性切共识的时间少一点。

确保分片启动后，可以进行如下测试，以max_block_change_view值为10为例。

分片共识管理涉及到共识周期，节点状态以及网络质押状态等。

## 共识周期0

共识周期0时，参与分片共识的只有在分片激活之前加入分片的节点。

### Case 1，检查共识状态

#### 步骤

1. 查询分片当前的共识周期；
2. 查询分片当前共识周期的质押状态和下一周期的质押状态；
3. 查询下下轮周期的质押状态。

#### 预期

1. 当前共识周期为0；
2. 当前周期和下一周期的质押状态一致，如下（以solo模式下的单节点为例）：
```
{
  "Peers": {
    "03c235f5e5ad2c4c58f17c99b051a23f9e32a2c1eba48dc500b6f11b5f7bd436fd": {
      "PeerPubKey": "03c235f5e5ad2c4c58f17c99b051a23f9e32a2c1eba48dc500b6f11b5f7bd436fd", // 节点公钥
      "Owner": "AZqk4i7Zhfhc1CRUtZYKrLw4YTSq4Y9khN", // 节点owner
      "CanStake": true, // 节点是否接受用户质押
      "WholeFee": 0, // 节点在该轮共识周期里的手续费收入
      "FeeBalance": 0, // 节点该轮共识周期的手续费收入还剩下多少未被用户提取
      "InitPos": 10000, // 该轮共识周期节点质押的token数量
      "UserUnfreezeAmount": 0, // 该轮共识周期节点解冻的质押token数量，包括用户解冻的和节点解冻的
      "CurrentViewStakeAmount": 0, // 该轮共识周期用户质押的token数量
      "UserStakeAmount": 0, // 用户质押的token的总数量
      "MaxAuthorization": 0, // 该轮共识周期节点能接受的最大的用户质押token的数量
      "Proportion": 0 // 节点会把该轮共识周期的手续费的多少比例分给用户，例如值为50的时候，节点会将50%的手续费分给用户
    }
  }
}
```
Peers是一个map格式的json，map的key是每个节点的公钥，value是该节点的质押状态，包括很多字段。
3. 下下轮的质押状态为空。

## 共识周期0与其他周期

共识切换的过程将在分片和主链之间异步进行，一般持续两到三个块的时间（分片和主链各经历两三个块）。由于是异步进行，所以整个共识切换完成之后在分片和主链上表现不同。在分片上，切换完成之后，可以查询到最新的共识切换信息，在主链上，可以查询到新周期的下一个周期的质押状态。

分片启动后，可以在任何时候有新的节点加入，已经加入分片的节点可以在任何时候退出。节点加入时，不会立即进入分片共识，得经过一轮共识切换才能加入共识。节点退出时，如果该节点是共识节点，需要经过两次共识切换才能退出分片，候选节点则只需要一轮共识切换。

### Case 1，节点加入正在运行的分片

假设当前共识周期为N，节点加入分片时，会对N+1，N+2轮的共识产生影响：如果N+2轮的质押状态不存在，则N+2轮的状态会变成与N+1轮一致。

#### 步骤

1. 查询分片当前的共识周期为N；
2. 节点加入分片；
3. 查询第N轮，N+1轮，N+2轮的质押状态以及分片详情；
4. 等一轮共识切换；
5. 查询N+1，N+2轮的共识状态以及分片详情。

#### 预期

1. 第一次查询，N轮不含有peer信息，N+1和N+2轮含有节点信息，并且分片详情的VBFT配置的Peers不含有该节点：
分片详情：
```
{
  "ShardID": 1,
  "Creator": "AZ3BTJt7jNGwJjVLsYJAyfLtCJ38Cd8Uri",
  "State": 3,
  "GenesisParentHeight": 17,
  "Config": {
    "GasPrice": 0,
    "GasLimit": 20000,
    "NetworkSize": 1,
    "StakeAssetAddress": "AFmseVrdL9f9oyCzZefL9tG6UbvhUMqNMV",
    "GasAssetAddress": "AFmseVrdL9f9oyCzZefL9tG6UbvhfRZMHJ",
    "VbftCfg": {
      "n": 7,
      "c": 2,
      "k": 7,
      "l": 112,
      "block_msg_delay": 5000,
      "hash_msg_delay": 10000,
      "peer_handshake_timeout": 10,
      "max_block_change_view": 5,
      "min_init_stake": 10000,
      "admin_ont_id": "did:ont:ARiwjLzjzLKZy8V43vm6yUcRG9b56DnZtY",
      "vrf_value": "1c9810aa9822e511d5804a9c4db9dd08497c31087b0daafa34d768a3253441fa20515e2f30f81741102af0ca3cefc4818fef16adb825fbaa8cad78647f3afb590e",
      "vrf_proof": "c57741f934042cb8d8b087b44b161db56fc3ffd4ffb675d36cd09f83935be853d8729f3f5298d12d6fd28d45dde515a4b9d7f67682d182ba5118abf451ff1988",
      "peers": [ // 不含有新加入的节点
        {
          "index": 1,
          "peerPubkey": "03c235f5e5ad2c4c58f17c99b051a23f9e32a2c1eba48dc500b6f11b5f7bd436fd",
          "address": "AZ3BTJt7jNGwJjVLsYJAyfLtCJ38Cd8Uri",
          "initPos": 10000
        }
      ]
    }
  },
  "Peers": { // 这个字段含有新加入的节点
    "0253ccfd439b29eca0fe90ca7c6eaa1f98572a054aa2d1d56e72ad96c466107a85": {
      "Index": 2,
      "IpAddress": "127.0.0.1:30338",
      "PeerOwner": "AZqk4i7Zhfhc1CRUtZYKrLw4YTSq4Y9khN",
      "PeerPubKey": "0253ccfd439b29eca0fe90ca7c6eaa1f98572a054aa2d1d56e72ad96c466107a85",
      "NodeType": 0
    },
    "03c235f5e5ad2c4c58f17c99b051a23f9e32a2c1eba48dc500b6f11b5f7bd436fd": {
      "Index": 1,
      "IpAddress": "127.0.0.1:30338",
      "PeerOwner": "AZ3BTJt7jNGwJjVLsYJAyfLtCJ38Cd8Uri",
      "PeerPubKey": "03c235f5e5ad2c4c58f17c99b051a23f9e32a2c1eba48dc500b6f11b5f7bd436fd",
      "NodeType": 1
    }
  }
}
```
N轮质押状态：
```
{
  "Peers": {
    "03c235f5e5ad2c4c58f17c99b051a23f9e32a2c1eba48dc500b6f11b5f7bd436fd": {
      "PeerPubKey": "03c235f5e5ad2c4c58f17c99b051a23f9e32a2c1eba48dc500b6f11b5f7bd436fd",
      "Owner": "AZqk4i7Zhfhc1CRUtZYKrLw4YTSq4Y9khN",
      "CanStake": true,
      "WholeFee": 0,
      "FeeBalance": 0,
      "InitPos": 10000,
      "UserUnfreezeAmount": 0,
      "CurrentViewStakeAmount": 0,
      "UserStakeAmount": 0,
      "MaxAuthorization": 0,
      "Proportion": 0
    }
  }
}
```
N+1轮，N+2轮质押状态：
```
{
  "Peers": {
    "0253ccfd439b29eca0fe90ca7c6eaa1f98572a054aa2d1d56e72ad96c466107a85": {
      "PeerPubKey": "0253ccfd439b29eca0fe90ca7c6eaa1f98572a054aa2d1d56e72ad96c466107a85",
      "Owner": "AZqk4i7Zhfhc1CRUtZYKrLw4YTSq4Y9khN",
      "CanStake": true,
      "WholeFee": 0,
      "FeeBalance": 0,
      "InitPos": 10001,
      "UserUnfreezeAmount": 0,
      "CurrentViewStakeAmount": 0,
      "UserStakeAmount": 0,
      "MaxAuthorization": 0,
      "Proportion": 0
    },
    "03c235f5e5ad2c4c58f17c99b051a23f9e32a2c1eba48dc500b6f11b5f7bd436fd": {
      "PeerPubKey": "03c235f5e5ad2c4c58f17c99b051a23f9e32a2c1eba48dc500b6f11b5f7bd436fd",
      "Owner": "AZqk4i7Zhfhc1CRUtZYKrLw4YTSq4Y9khN",
      "CanStake": true,
      "WholeFee": 0,
      "FeeBalance": 0,
      "InitPos": 10000,
      "UserUnfreezeAmount": 0,
      "CurrentViewStakeAmount": 0,
      "UserStakeAmount": 0,
      "MaxAuthorization": 0,
      "Proportion": 0
    }
  }
}
```
2. 第二次查询分片详情里该节点会跟其他节点按照质押的ONT的多少排列，多的在前，少的在后，并且新加入的节点按照质押量排序后如果在配置的前```K```个节点里，则该节点的NodeType为1：
```
{
  "ShardID": 1,
  "Creator": "AZ3BTJt7jNGwJjVLsYJAyfLtCJ38Cd8Uri",
  "State": 3,
  "GenesisParentHeight": 17,
  "Config": {
    "GasPrice": 0,
    "GasLimit": 20000,
    "NetworkSize": 1,
    "StakeAssetAddress": "AFmseVrdL9f9oyCzZefL9tG6UbvhUMqNMV",
    "GasAssetAddress": "AFmseVrdL9f9oyCzZefL9tG6UbvhfRZMHJ",
    "VbftCfg": {
      "n": 7,
      "c": 2,
      "k": 7,
      "l": 112,
      "block_msg_delay": 5000,
      "hash_msg_delay": 10000,
      "peer_handshake_timeout": 10,
      "max_block_change_view": 5,
      "min_init_stake": 10000,
      "admin_ont_id": "did:ont:ARiwjLzjzLKZy8V43vm6yUcRG9b56DnZtY",
      "vrf_value": "1c9810aa9822e511d5804a9c4db9dd08497c31087b0daafa34d768a3253441fa20515e2f30f81741102af0ca3cefc4818fef16adb825fbaa8cad78647f3afb590e",
      "vrf_proof": "c57741f934042cb8d8b087b44b161db56fc3ffd4ffb675d36cd09f83935be853d8729f3f5298d12d6fd28d45dde515a4b9d7f67682d182ba5118abf451ff1988",
      "peers": [ // 新加入的节点由于质押的更多，所以排序较前
        {
          "index": 2,
          "peerPubkey": "0253ccfd439b29eca0fe90ca7c6eaa1f98572a054aa2d1d56e72ad96c466107a85",
          "address": "AZqk4i7Zhfhc1CRUtZYKrLw4YTSq4Y9khN",
          "initPos": 12000
        },
        {
          "index": 1,
          "peerPubkey": "03c235f5e5ad2c4c58f17c99b051a23f9e32a2c1eba48dc500b6f11b5f7bd436fd",
          "address": "AZ3BTJt7jNGwJjVLsYJAyfLtCJ38Cd8Uri",
          "initPos": 10000
        }
      ]
    }
  },
  "Peers": {
    "0253ccfd439b29eca0fe90ca7c6eaa1f98572a054aa2d1d56e72ad96c466107a85": {
      "Index": 2,
      "IpAddress": "127.0.0.1:30338",
      "PeerOwner": "AZqk4i7Zhfhc1CRUtZYKrLw4YTSq4Y9khN",
      "PeerPubKey": "0253ccfd439b29eca0fe90ca7c6eaa1f98572a054aa2d1d56e72ad96c466107a85",
      "NodeType": 1
    },
    "03c235f5e5ad2c4c58f17c99b051a23f9e32a2c1eba48dc500b6f11b5f7bd436fd": {
      "Index": 1,
      "IpAddress": "127.0.0.1:30338",
      "PeerOwner": "AZ3BTJt7jNGwJjVLsYJAyfLtCJ38Cd8Uri",
      "PeerPubKey": "03c235f5e5ad2c4c58f17c99b051a23f9e32a2c1eba48dc500b6f11b5f7bd436fd",
      "NodeType": 1
    }
  }
}
```

### Case 2，共识节点退出分片正在运行的分片

#### 步骤

1. 查询分片当前的共识周期为N，并且确保当前轮不会有节点加入分片且N+2轮的质押状态查询不到；
2. 共识节点退出分片；
3. 查询第N轮，N+1轮，N+2轮的质押状态以及分片详情；
4. 等一轮共识切换；
5. 查询N+1，N+2轮的共识状态以及分片详情；
6. 第二轮共识切换，查询N+1，N+2及N+3轮的共识状态及分片详情。

#### 预期

1. 退出交易落账后，共识切换前分片详情的退出节点的NodeType为1，N、N+1分片质押状态的CanStake为false，表示不接受用户质押了。
2. 共识切换后，NodeType为2，N+2轮的CanStake依旧为false。
3. 再次共识切换后，NodeType为3，N+3轮的CanStake依旧为false。

### Case 3，候选节点退出分片正在运行的分片

#### 步骤

1. 查询分片当前的共识周期为N，并且确保当前轮不会有节点加入分片且N+2轮的质押状态查询不到；
2. 候选节点退出分片；
3. 查询第N轮，N+1轮，N+2轮的质押状态以及分片详情；
4. 等一轮共识切换；
5. 查询N+1，N+2轮的共识状态以及分片详情；
6. 第二轮共识切换，查询N+1，N+2及N+3轮的共识状态及分片详情。

#### 预期

1. 退出交易落账后，共识切换前分片详情的退出节点的NodeType为0，N、N+1分片质押状态的CanStake为false，表示不接受用户质押了。
2. 共识切换后，NodeType为3，N+2轮的CanStake依旧为false。

### Case 4，共识切换测试

#### 步骤

1. 记录当前共识周期N的分片详情和质押状态；
2. 等待切共识；
3. 记录N+1轮的分片详情和质押状态。

#### 预期

不发生节点变化和用户质押，两次查询的结果应保持一致

### Case 4，强制共识切换测试

#### 步骤

1. 记录当前共识周期N的分片详情和质押状态；
2. 使用新的配置强制切换共识；
3. 记录N+1轮的分片详情和质押状态。

#### 预期

除配置更新外，其他均不变。