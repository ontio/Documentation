# 分片节点管理测试用例

## 分片创建

1. 分片可以由任何人创建；2. 分片创建时需要扣除手续费，默认是100 ONG；

分片创建之后，主链节点可以申请加入分片；分片上的节点大于等于七个之后，可以启动分片。

创建参数：
```
type CreateShardParam struct {
	ParentShardID common.ShardID // 要创建的分片的父分片ID
	Creator       common.Address // 分片创建人
}
```

已有的ontology主链的shardId为0。

### Case 1, 创建成功

#### 步骤

1. 确保分片创建者的地址有超过分片创建手续费的ONG；
2. 发送分片创建交易，参数中的ParentShardID填主链的ShardID；
3. Creator填交易发送人；
4. 发送交易，等待交易落账；
5. 查询创建的分片的详情，检查查询结果。

#### 预期

```
{
  "ShardID": 1,
  "Creator": "AKuMYaCm7LeBHqNeKzvj7qQb3USakDr5yg",
  "State": 0,
  "GenesisParentHeight": 0,
  "Config": {
    "GasPrice": 0,
    "GasLimit": 0,
    "NetworkSize": 0,
    "StakeAssetAddress": "AFmseVrdL9f9oyCzZefL9tG6UbvhPbdYzM",
    "GasAssetAddress": "AFmseVrdL9f9oyCzZefL9tG6UbvhPbdYzM",
    "VbftCfg": {
      "n": 0,
      "c": 0,
      "k": 0,
      "l": 0,
      "block_msg_delay": 0,
      "hash_msg_delay": 0,
      "peer_handshake_timeout": 0,
      "max_block_change_view": 0,
      "min_init_stake": 0,
      "admin_ont_id": "",
      "vrf_value": "",
      "vrf_proof": "",
      "peers": []
    }
  },
  "Peers": {}
}
 ```
 ShardID和Creator会变化，其他值固定。
 
### Case 2，创建失败-ONG不足

#### 步骤

1. 确保分片创建者的地址的ONG不足以创建分片；
2. 发送分片创建交易，参数中的ParentShardID填主链的ShardID；
3. Creator填交易发送人；
4. 发送交易，等待交易落账。

#### 预期

交易执行失败，分片创建失败。
 
 
### Case 3，创建失败-参数ParentShardID错误

#### 步骤

1. 确保分片创建者的地址的ONG足以创建分片；
2. 发送分片创建交易，参数中的ParentShardID填非主链的ShardID；
3. Creator填交易发送人；
4. 发送交易，等待交易落账。

#### 预期

交易执行失败，分片创建失败。
 
### Case 4，创建失败-参数Creator错误

#### 步骤

1. 确保分片创建者的地址的ONG足以创建分片；
2. 发送分片创建交易，参数中的ParentShardID填主链的ShardID；
3. Creator填非交易发送人；
4. 发送交易，等待交易落账。

#### 预期

交易执行失败，分片创建失败。

## 分片配置

分片创建好之后需要进行配置，配置内容包括"GasPrice", "GasLimit", "NetworkSize", "StakeAssetAddress", "GasAssetAddress"以及VBFT配置。

分片配置只能由分片创建者修改。

"GasPrice", "GasLimit"如果都配置成0或者不配置，则会被设置为默认值0和20000，"NetworkSize"必须大于1，"StakeAssetAddress"和"GasAssetAddress"必须是ONT和ONG的合约地址。VBFT配置必须满足通用的VBFT的配置条件。

### Case 1，正常配置

#### 步骤

1. 各项配置正确；
2. 由分片创建者发送交易到主链上；
3. 等待交易落账；
4. 查询分片详情，检查详情中的配置是否与设置的一致。

#### 预期

交易成功，配置一致。

### Case 2，错误配置

#### 步骤

1. 有某些配置不满足上文提到的约束条件；
2. 由分片创建者发送交易到主链上；
3. 等待交易落账；
4. 查询分片详情，检查详情中的配置是否与设置的一致。

#### 预期

交易失败，详情中的State为0。

### Case 3，发送人错误

#### 步骤

1. 有某些配置不满足上文提到的约束条件；
2. 由非分片创建者发送交易到主链上；
3. 等待交易落账；
4. 查询分片详情，检查详情中的配置是否与设置的一致。

#### 预期

交易失败，详情中的State为0。

## 节点申请

加入分片的节点必须是parent的候选节点和共识节点。

参数：
```
type ApplyJoinShardParam struct {
	ShardId    common.ShardID
	PeerOwner  common.Address
	PeerPubKey string
}
```

### Case 1，正常申请

#### 步骤

1. ShardId填写要加入的分片Id；
2. PeerOwner填写节点的Owner地址，同时也是交易的发送人；
3. PeerPubKey填写节点的公钥；
4. 由peerOwner创建并发送交易；
5. 等待交易落账，检查shard详情。

#### 预期

交易成功，shard详情应与分片创建之后保持一致。

### Case 2，申请加入不存在的分片

#### 步骤

1. ShardId填写要加入的分片Id，该分片尚未创建；
2. PeerOwner填写节点的Owner地址，同时也是交易的发送人；
3. PeerPubKey填写节点的公钥；
4. 由peerOwner创建并发送交易；
5. 等待交易落账，检查shard详情。

#### 预期

交易失败。

### Case 3，Owner填写错误

#### 步骤

1. ShardId填写要加入的分片Id，该分片尚未创建；
2. PeerOwner填写交易的发送人，但不是节点的owner；
3. PeerPubKey填写节点的公钥；
4. 由peerOwner创建并发送交易；
5. 等待交易落账，检查shard详情。

#### 预期

交易失败。

### Case 4，PeerPubKey填写错误

#### 步骤

1. ShardId填写要加入的分片Id，该分片尚未创建；
2. PeerOwner填写节点的Owner地址，同时也是交易的发送人；
3. PeerPubKey填写其他的公钥；
4. 由peerOwner创建并发送交易；
5. 等待交易落账，检查shard详情。

#### 预期

交易失败。

## 节点审批

节点申请加入分片之后，需要由分片创建者批准。未经过批准的节点将无法加入分片。
参数：
```
type ApproveJoinShardParam struct {
	ShardId    common.ShardID
	PeerPubKey []string
}
```

### Case 1，正常审批

#### 步骤

1. ShardId填写要审批的分片Id；
2. PeerPubKey填写要审批的节点公钥；
3. 发送交易，等待落账。

#### 预期

交易成功，shard详情应与分片创建之后保持一致。

### Case 2，ShardId错误

#### 步骤

1. ShardId填写要错误的分片Id，可以是未创建的分片，可以是其他人创建的；
2. PeerPubKey填写要审批的节点公钥；
3. 发送交易，等待落账。

#### 预期

交易失败。

### Case 3，PeerPubKey错误

#### 步骤

1. ShardId填写要审批的分片Id；
2. PeerPubKey填写要审批的节点公钥，这些节点没有申请加入分片；
3. 发送交易，等待落账。

#### 预期

交易失败。

## 节点加入

审批通过的节点可以正式加入分片，加入分片分片需要扣除一定量的ONG作为手续费，目前的默认值是100 ONG。节点加入时同时会扣除初始的抵押token，即ONT，扣除的值由节点自己指定，但是不能少于分片配置的最小值“min_init_stake”。

节点在分片上质押的token必须小于在主链上的质押。

参数；
```
type JoinShardParam struct {
	ShardID     common.ShardID
	IpAddress   string
	PeerOwner   common.Address
	PeerPubKey  string
	StakeAmount uint64
}
```

### Case 1，正常加入

#### 步骤

确保账户中有足够的ONT和ONG。ONT >= StakeAmount，ONG >= 节点加入的手续费。

1. ShardId填写要加入的分片Id；
2. IpAddress填写节点将要运行的机器的IP；
3. PeerOwner填写节点的Owner地址，同时也是交易的发送人；
4. PeerPubKey填写节点的公钥；
5. StakeAmount填写节点初始质押多少ONT；
6. 发送交易，等待交易落账。

#### 预期

交易成功，shard详情中的Peers和VBFT配置中的Peers都应有新加入的Peer，分片的state变成了2。

### Case 2，ShardId填写错误

#### 步骤

确保账户中有足够的ONT和ONG。ONT >= StakeAmount，ONG >= 节点加入的手续费。

1. ShardId填写要加入的分片Id，该分片尚未创建；
2. IpAddress填写节点将要运行的机器的IP；
3. PeerOwner填写节点的Owner地址，同时也是交易的发送人；
4. PeerPubKey填写节点的公钥；
5. StakeAmount填写节点初始质押多少ONT；
6. 发送交易，等待交易落账。

#### 预期

交易失败。

### Case 3，PeerOwner填写错误

#### 步骤

确保账户中有足够的ONT和ONG。ONT >= StakeAmount，ONG >= 节点加入的手续费。

1. ShardId填写要加入的分片Id，该分片尚未创建；
2. IpAddress填写节点将要运行的机器的IP；
3. PeerOwner填写交易的发送人，但不是节点的owner；
4. PeerPubKey填写节点的公钥；
5. StakeAmount填写节点初始质押多少ONT；
6. 发送交易，等待交易落账。

#### 预期

交易失败。

### Case 4，PeerPubKey填写错误

#### 步骤

确保账户中有足够的ONT和ONG。ONT >= StakeAmount，ONG >= 节点加入的手续费。

1. ShardId填写要加入的分片Id，该分片尚未创建；
2. IpAddress填写节点将要运行的机器的IP；
3. PeerOwner填写节点的Owner地址，同时也是交易的发送人；
4. PeerPubKey填写其他公钥；
5. StakeAmount填写节点初始质押多少ONT；
6. 发送交易，等待交易落账。

#### 预期

交易失败。

### Case 5，StakeAmount填写错误

#### 步骤

确保账户中有足够的ONT和ONG。ONT >= StakeAmount，ONG >= 节点加入的手续费。

1. ShardId填写要加入的分片Id，该分片尚未创建；
2. IpAddress填写节点将要运行的机器的IP；
3. PeerOwner填写节点的Owner地址，同时也是交易的发送人；
4. PeerPubKey填写其他公钥；
5. StakeAmount填写节点初始质押多少ONT，超过在主链上质押的token；
6. 发送交易，等待交易落账。

#### 预期

交易失败。

### Case 6，ONG不足

#### 步骤

确保账户中有足够的ONT和不够的ONG。ONT >= StakeAmount，ONG < 节点加入的手续费。

1. ShardId填写要加入的分片Id；
2. IpAddress填写节点将要运行的机器的IP；
3. PeerOwner填写节点的Owner地址，同时也是交易的发送人；
4. PeerPubKey填写节点的公钥；
5. StakeAmount填写节点初始质押多少ONT；
6. 发送交易，等待交易落账。

#### 预期

交易失败。

### Case 6，ONT不足

#### 步骤

确保账户中有足够的ONG和不够的ONT。ONT < StakeAmount，ONG >= 节点加入的手续费。

1. ShardId填写要加入的分片Id；
2. IpAddress填写节点将要运行的机器的IP；
3. PeerOwner填写节点的Owner地址，同时也是交易的发送人；
4. PeerPubKey填写节点的公钥；
5. StakeAmount填写节点初始质押多少ONT；
6. 发送交易，等待交易落账。

#### 预期

交易失败。

## 激活分片

在有至少七个节点加入分片之后，分片创建者可以激活分片。

参数：
```
type ActivateShardParam struct {
	ShardID common.ShardID
}
```

### Case 1，正常激活

#### 步骤

1. ShardId填写要激活的分片Id；
2. 发送交易，等待交易落账。

#### 预期

交易成功，查询分片详情可以看到分片的state变成了3，同时分片详情的VBFT配置的Peers按照质押token的多少拍好了顺序。

### Case 1，激活失败

#### 步骤

1. ShardId填写要错误的分片Id；
2. 发送交易，等待交易落账。

#### 预期

交易失败。

## 设置创建分片的费用值

创建分片需要支付一定量的手续费，默认是100 ONG，这个值可以通过调用ShardMgmt合约修改。

参数：
```
Fee *big.Int
```

### Case 1, 正常修改

#### 步骤

1. 由主链上的管理员构造交易，发送到主链上；
2. 等待交易落账；
3. 创建分片，观察扣费数量。

#### 预期

扣费数量是新设置的值。

## 设置加入分片的费用值

加入分片需要支付一定量的手续费，默认是100 ONG，这个值可以通过调用ShardMgmt合约修改。

参数：
```
Fee *big.Int
```

### Case 1, 正常修改

#### 步骤

1. 由主链上的管理员构造交易，发送到主链上；
2. 等待交易落账；
3. 节点加入分片，观察扣费数量。

#### 预期

扣费数量是新设置的值。



## 设置创建和加入分片扣的资产

创建和加入分片需要支付一定量的手续费，默认使用ONG支付，可以通过调用ShardMgmt合约修改成使用其他资产支付。

参数：
```
Address common.Address
```

### Case 1, 正常修改

#### 步骤

1. 部署一本OEP-4资产合约并初始化；
2. 由主链上的管理员构造交易，参数填部署的OEP-4资产的合约地址，发送到主链上；
3. 等待交易落账；
4. 创建分片，观察扣费的种类；
5. 加入分片，观察扣费的种类。

#### 预期

扣掉的资产是部署的OEP-4资产。