# 分片用户质押与手续费分润

与主链一样，用户可以质押分片的节点以获取借点手续费的分润。但这有几个前置条件：
1. 节点接受用户质押，即节点的```MaxAuthorization```必须大于0；
2. 节点设置好分配给用户的手续费的比例，即节点的```Proportion```必须位于区间(0, 100]之间。

节点的手续费分配规则如下：假设一轮共识周期的手续费总额（该总额是减去分片负债之后的值）为O，则每个节点按该节点的总质押（节点的```InitPos```加上该节点的用户质押）占分片的总质押的比例分配手续费，每个节点分到的手续费为OP。节点本身（Owner）分配到的手续费为 OP*(100-```Proportion```)/100，用户在该节分到的手续费为 OP*```Proportion```/100*(用户质押数/当前节点的用户总质押)。用户在一轮共识周期后能分到的所有手续费是该用户在所有节点可以分到的手续费之和，因为用户可以质押多个节点。

分片一轮共识周期的手续费是在公式切换时分片上ShardMgmt合约地址上的所有ONG，在切换的时候，这些ONG会被打到主链上的ShardStake合约里，用户和节点Owner提取收益时，是从主链上的ShardStake合约提取ONG到自己的地址上。用户质押ONT是，质押的ONT也是转入到ShardStake合约里。用户质押的ONT自然解绑产生的ONG可以随时从ShardStake合约里提取。

为了方便测试，分片的手续费收入可以通过直接往分片的ShardMgmt合约转入ONG获得，而不用通过刷分片交易扣手续费获取。更简单的方式是直接从主链上跨分片转移ONG到分片上的ShardMgmt合约，这样可以控制每一轮共识周期的手续费收入。

用户可以质押节点，但是节点Owner不能质押自己的节点，只能通过addInitPOS或者reduceInitPos改变在自己节点上的质押token。用户和节点可以随时改变质押情况，但是这种改变总是会到下一轮共识周期才会生效，这与分片共识的节点管理类似。

“生效”是指对网络产生影响，比如说影响节点的共识排名，用来计算参与手续费分润的比例等等。

## Case 1，改变节点的MaxAuthorization与Proportion

1. 分片正常运行，当前共识周期为N；
2. 查询当前轮及下一轮的质押状态；
3. 改变节点的MaxAuthorization与Proportion；
4. 查询当前轮及下一轮的质押状态；
5. 等待共识切换，查询N,N+1,N+2轮的共识状态。

### 预期

切换共识之前N+1轮的节点状态的MaxAuthorization与Proportion为设置的值，切换共识之后N+1与N+2轮的MaxAuthorization与Proportion都是改变之后的值。

## Case 2，节点无法接受超过MaxAuthorization的token质押

1. 分片正常运行，当前共识周期为N；
2. 查询当前质押状态，找一个MaxAuthorization较小的节点；
3. 向该节点质押超过MaxAuthorization个token。

### 预期

质押失败

Case 3，用户和节点Owner提取自然解绑的ONG

1. 用户质押一个节点，一段时间后提取自然解绑的ONG；
2. 节点Owner提取自然解绑的ONG，过一段时间后再次提取；

### 预期

提取的ONG的数量与自然解绑的相等

Case 4，用户的当前轮质押可以在当前轮取消

用户的发起质押交易之后，token会马上进入ShardStake合约里，但是到下轮共识质押才会生效。

1. 确保用户当前轮无可提取的质押资产，可以先提取，或者使用一个没有质押过的用户；
2. 查询当前和下一轮的质押状态以及用户质押状态；
3. 用户质押节点，查询当前和下一轮的质押状态以及用户质押状态；
4. 用户提取解冻的质押token，查询当前和下一轮的质押状态以及用户质押状态。

### 预期

质押后，当前轮质押节点的CurrentViewStakeAmount增加用户的质押值，下一轮的UserStakeAmount增加用户的质押值，用户的质押状态包含有新的节点质押；用户提取解冻的质押token，质押状态与用户质押之前一致，用户的质押状态中当前轮该节点的CurrentViewStakeAmount为0，下一轮的StakeAmount减少提取的值。示例(以一个节点为例)如下：

质押前：

当前轮分片质押状态与用户质押状态：
```
// 节点质押状态
{
  "Peers": {
    "03d2b2e7e56c91c946ef8b50078725704f24a7e161b997e1998bf04abca272c3c1": {
      "PeerPubKey": "03d2b2e7e56c91c946ef8b50078725704f24a7e161b997e1998bf04abca272c3c1",
      "Owner": "AZ3BTJt7jNGwJjVLsYJAyfLtCJ38Cd8Uri",
      "CanStake": true,
      "WholeFee": 0,
      "FeeBalance": 0,
      "InitPos": 10000,
      "UserUnfreezeAmount": 0,
      "CurrentViewStakeAmount": 0,
      "UserStakeAmount": 0,
      "MaxAuthorization": 0,
      "Proportion": 0
    }
  }
}

// 用户质押状态
{"Peers":{}}
```
下一轮分片质押状态与用户质押状态：
```
// 节点质押状态
{
  "Peers": {
    "03d2b2e7e56c91c946ef8b50078725704f24a7e161b997e1998bf04abca272c3c1": {
      "PeerPubKey": "03d2b2e7e56c91c946ef8b50078725704f24a7e161b997e1998bf04abca272c3c1",
      "Owner": "AZ3BTJt7jNGwJjVLsYJAyfLtCJ38Cd8Uri",
      "CanStake": true,
      "WholeFee": 0,
      "FeeBalance": 0,
      "InitPos": 10000,
      "UserUnfreezeAmount": 0,
      "CurrentViewStakeAmount": 0,
      "UserStakeAmount": 0,
      "MaxAuthorization": 500000,
      "Proportion": 50
    }
  }
}

// 用户质押状态
{"Peers":{}}
```
质押后：

当前轮分片质押状态与用户质押状态：
```
// 节点质押状态
{
  "Peers": {
    "03d2b2e7e56c91c946ef8b50078725704f24a7e161b997e1998bf04abca272c3c1": {
      "PeerPubKey": "03d2b2e7e56c91c946ef8b50078725704f24a7e161b997e1998bf04abca272c3c1",
      "Owner": "AZ3BTJt7jNGwJjVLsYJAyfLtCJ38Cd8Uri",
      "CanStake": true,
      "WholeFee": 0,
      "FeeBalance": 0,
      "InitPos": 10000,
      "UserUnfreezeAmount": 0,
      "CurrentViewStakeAmount": 80, // 这里增加了80
      "UserStakeAmount": 0,
      "MaxAuthorization": 0,
      "Proportion": 0
    }
  }
}

// 用户质押状态
{
  "Peers": {
    "03d2b2e7e56c91c946ef8b50078725704f24a7e161b997e1998bf04abca272c3c1": {
      "PeerPubKey": "03d2b2e7e56c91c946ef8b50078725704f24a7e161b997e1998bf04abca272c3c1",
      "StakeAmount": 0,
      "CurrentViewStakeAmount": 80, // 这里增加了80
      "UnfreezeAmount": 0
    }
  }
}
```

下一轮轮分片质押状态与用户质押状态：
```
// 节点质押状态
{
  "Peers": {
    "03d2b2e7e56c91c946ef8b50078725704f24a7e161b997e1998bf04abca272c3c1": {
      "PeerPubKey": "03d2b2e7e56c91c946ef8b50078725704f24a7e161b997e1998bf04abca272c3c1",
      "Owner": "AZ3BTJt7jNGwJjVLsYJAyfLtCJ38Cd8Uri",
      "CanStake": true,
      "WholeFee": 0,
      "FeeBalance": 0,
      "InitPos": 10000,
      "UserUnfreezeAmount": 0,
      "CurrentViewStakeAmount": 0, // 这里为0
      "UserStakeAmount": 80, // 这里增加了80
      "MaxAuthorization": 500000,
      "Proportion": 50
    }
  }
}

// 用户质押状态
{
  "Peers": {
    "03d2b2e7e56c91c946ef8b50078725704f24a7e161b997e1998bf04abca272c3c1": {
      "PeerPubKey": "03d2b2e7e56c91c946ef8b50078725704f24a7e161b997e1998bf04abca272c3c1",
      "StakeAmount": 80, // 这里增加了80
      "CurrentViewStakeAmount": 0, // 这里位0
      "UnfreezeAmount": 0
    }
  }
}
```
提取解冻的质押token后：

当前轮分片质押状态与用户质押状态：
```
// 节点质押状态
{
  "Peers": {
    "03d2b2e7e56c91c946ef8b50078725704f24a7e161b997e1998bf04abca272c3c1": {
      "PeerPubKey": "03d2b2e7e56c91c946ef8b50078725704f24a7e161b997e1998bf04abca272c3c1",
      "Owner": "AZ3BTJt7jNGwJjVLsYJAyfLtCJ38Cd8Uri",
      "CanStake": true,
      "WholeFee": 0,
      "FeeBalance": 0,
      "InitPos": 10000,
      "UserUnfreezeAmount": 0,
      "CurrentViewStakeAmount": 0, // 这里减少了80
      "UserStakeAmount": 0,
      "MaxAuthorization": 0,
      "Proportion": 0
    }
  }
}

// 用户质押状态
{
  "Peers": {
    "03d2b2e7e56c91c946ef8b50078725704f24a7e161b997e1998bf04abca272c3c1": {
      "PeerPubKey": "03d2b2e7e56c91c946ef8b50078725704f24a7e161b997e1998bf04abca272c3c1",
      "StakeAmount": 0,
      "CurrentViewStakeAmount": 0, // 这里减少了80
      "UnfreezeAmount": 0
    }
  }
}
```

下一轮轮分片质押状态与用户质押状态：
```
// 节点质押状态
{
  "Peers": {
    "03d2b2e7e56c91c946ef8b50078725704f24a7e161b997e1998bf04abca272c3c1": {
      "PeerPubKey": "03d2b2e7e56c91c946ef8b50078725704f24a7e161b997e1998bf04abca272c3c1",
      "Owner": "AZ3BTJt7jNGwJjVLsYJAyfLtCJ38Cd8Uri",
      "CanStake": true,
      "WholeFee": 0,
      "FeeBalance": 0,
      "InitPos": 10000,
      "UserUnfreezeAmount": 0,
      "CurrentViewStakeAmount": 0, // 这里为0
      "UserStakeAmount": 0, // 这里减少了80
      "MaxAuthorization": 500000,
      "Proportion": 50
    }
  }
}

// 用户质押状态
{
  "Peers": {
    "03d2b2e7e56c91c946ef8b50078725704f24a7e161b997e1998bf04abca272c3c1": {
      "PeerPubKey": "03d2b2e7e56c91c946ef8b50078725704f24a7e161b997e1998bf04abca272c3c1",
      "StakeAmount": 0, // 这里减少了80
      "CurrentViewStakeAmount": 0, // 这里位0
      "UnfreezeAmount": 0
    }
  }
}
```

## Case 5，用户质押在下一轮共识才能生效

1. 确保用户当前轮无可提取的质押资产，可以先提取，或者使用一个没有质押过的用户；
2. 查询当前和下一轮的质押状态以及用户质押状态；
3. 用户质押节点，查询当前和下一轮的质押状态以及用户质押状态；
4. 等待一轮共识切换，查询当前和下一轮的质押状态以及用户质押状态。

### 预期

用户与节点当前轮的CurrentViewStakeAmount在切换一轮共识之后会变成StakeAmount。

## Case 6，节点增加InitPos，在下一轮共识才能生效

节点Owner不能直接质押自己的节点，只能通过AddInitPos方法，增加自己在自己的节点上的质押。AddInitPos同样会立即把质押Token转入到ShardStake合约里，但是对节点的影响会到下一轮共识才生效。

1. 查询当前轮和下一轮的质押状态；
2. 节点Owner做AddInitPos；
3. 查询当前轮和下一轮的质押状态；
4. 等待切换一轮共识；
5. 查询当前轮的质押状态；

### 预期

节点的InitPos在下一轮才会生效。经过共识切换后，新的一轮的节点的InitPos增加了。


## Case 7，节点减少InitPos，到下一轮共识才能生效，提取减少的质押的token

节点owner通过ReduceInitPos可以减少自己的InitPos，减少的值会变成解冻的状态，经过一轮共识之后才能提取出来。

1. 查询当前轮和下一轮的质押状态，查询Owner的用户质押状态；
2. 节点Owner做ReduceInitPos；
3. 查询当前轮和下一轮的质押状态，查询Owner的用户质押状态；
4. 等待切换一轮共识；
5. 查询当前轮的质押状态，查询Owner的用户质押状态；
6. Owner提取减少的InitPos。

### 预期

1. ReduceInitPos之后当前轮不受影响，切换共识之后，减少的InitPos增加到了Owner的UnfreezeAmount值中，同时节点质押状态的UserUnfreezeAmount也增加了相应的值，InitPos减少了相应的值；
2. 切换共识之后，Owner可以把这部分值提取出来。

## Case 8，用户质押在下一轮共识才会生效

用户可以质押节点，但是这种质押到下一轮才会生效。

1. 查询当前轮和下一轮的质押状态和用户质押节点的信息；
2. 用户质押节点；
3. 查询当前轮和下一轮的质押状态和用户质押节点的信息；
4. 等待一轮共识切换；
5. 查询当前轮的质押状态和用户质押节点的信息。

### 预期

1. 质押后用户当前轮的CurrentViewStakeAmount增加质押的值，下一轮的StakeAmount增加同样的值，节点当前轮的CurrentViewStakeAmount和下一轮的UserStakeAmount增加同样的值；
2. 共识切换后，新的共识状态代替了旧的，节点和用户的CurrentViewStakeAmount都变成了0，StakeAmount受影响变大了。

## Case 9，用户解冻质押的token

用户质押节点之后，可以取消这些质押，这被称为解冻质押，解冻的质押token要到下一轮共识周期才能提取出来。

1. 查询当前轮和下一轮的质押状态和用户质押节点的信息；
2. 用户解冻；
3. 查询当前轮和下一轮的质押状态和用户质押节点的信息；
4. 等待一轮共识切换；
5. 查询当前轮的质押状态和用户质押节点的信息；
6. 提取解冻的token；

### 预期

1. 解冻对当前轮没有影响，下一轮用户的UserStakeAmount减少，UserUnfreezeAmount增加，用户质押状态和节点质押状态都是这样变化；
2. 切换共识后，用户能把当前轮的UserUnfreezeAmount提取出来，可以看到提取的数量正好是上一轮解冻的数量。

## Case 10，节点退出的影响————候选节点

节点可以自由加入和退出共识，当节点Owner调用退出共识接口后，节点将不能接受质押，也不能改变InitPos。同样的，节点的退出依旧要经过一轮共识才会生效，如果节点是共识节点，则需要经过两轮。节点退出共识周期的那一轮依旧可以享受手续费分润，共识节点经过的多一轮的共识周期也能享受手续费分润。节点退出后，节点的InitPos会变成节点Owner的UnfreezeAmount，即节点状态的UserUnfreezeAmount和节点owner的用户质押状态的UnfreezeAmount会增加InitPos的值。

1. 查询当前轮和下一轮的质押状态和用户质押节点的信息；
2. 候选节点退出；
3. 查询当前轮和下一轮的质押状态和用户质押节点的信息；
4. 等待一轮共识切换；
5. 查询当前轮的质押状态和用户质押节点的信息。

### 预期

1. 节点申请退出后，当前轮和下一轮的CanStake都变成了False，Owner的用户质押状态不变；
2. 共识切换后，节点的InitPos变成零，UserUnfreezeAmount增加相应的值，Owner的用户质押状态的UnfreezeAmount增加相应的值。

## Case 11，节点退出的影响————共识节点

与Case 10无太大差别，只是共识节点要经过两轮共识才能退出。

## Case 12，手续费分配————总收入

分片在运行过程中，会扣除用户的交易手续费至分片上的ShardMgmt合约中；在每一轮共识切换时，这部分手续费会被转入主链上的ShardStake合约里，供节点和用户提取。

1. 启动分片，确保分片的gasPrice大于0，查询分片上ShardMgmt合约的余额；
2. 在分片上发送交易，等待交易落账；
3. 查询交易被扣的手续费及ShardMgmt合约的余额；
4. 可以重复步骤2-3多次，观察ShardMgmt合约余额的变化；
5. 等待一轮共识切换，查询ShardMgmt合约的余额；
6. 查询主链上ShardStake余额的变化。

### 预期

1. 每笔交易都会被扣费，ShardMgmt接收每一笔交易的手续费；
2. 共识切换完成后，ShardMgmt的余额会变为0，因为每一轮的手续费收入都会被跨分片转入到主链的ShardStake合约里。

## Case 13，手续费分配————跨分片手续费结算

在同步跨分片调用（InvokeRemoteShard）的过程中，手续费将在分片之间结算，具体为：被调用的分片只会计算自己应收多少费用（如果原始交易的gasPrice小于分片自己的gasPrice，则交易不执行），然后将计算结果保存下来，并不收费；调用者支付被调用分片收取的费用到自己分片的ShardMgmt里，并且在共识切换之后，将这部分手续费支付给被调用的分片。这种支付并不是跨分片将手续费转入到被调用的分片，而是在ShardStake里结算，直接将应付手续费计入到被调用的shard的收入里。

同时，这种结算方式会在主链上形成账目，以供查询。

1. 确保调用分片和被调用分片都在运行；
2. 发起一笔跨分片调用交易（InvokeRemoteShard），确保该交易成功（gasLimit可以设置大一点）；
3. 等待调用分片和被调分片切换共识，为不被其他因素干扰，调用分片和被调用分片在这一轮共识周期不要有其他交易；
4. 分别查询两个分片的跨分片手续费账目，查询两个分片的质押状态。

### 预期

1. 查询出的手续费账目中，调用分片的负债等于被调用分片的收入；
2. 调用分片的质押状态里的手续费收入小于这笔跨分片交易的手续费，少掉的部分在被调用分片质押状态里可以查到。

## Case 14，手续费分配————节点收入

分片切换共识后，手续费收入会按照各个节点的质押数量按比例分配。为方便测试，可以直接将ONG转入到分片的ShardMgmt合约里，这样分片共识切换后，转入的ONG都会被当成手续费转入主链的ShardStake合约里。

1. 打入一笔ONG到分片的ShardMgmt合约里，可以跨分片转也可以在分片里面转；
2. 等待共识切换，为方便测试计数，确保这一轮没有其他交易发生；
3. 共识切换后查询这一轮的质押状态。

### 预期

1. 所有节点的WholeFee加起来等于当轮手续费总收入；
2. 每个节点的WholeFee是按照节点的质押总量分配的。

## Case 15，手续费分配————用户提取手续费

用户和节点Owner都可以提取手续费收入。

用户提取手续费时，会将该用户在所有共识周期的收益尽可能地提取出来，最多提取100轮共识周期的收益。例如，用户A在第五轮的时候押了节点，然后一直没有解冻过，现在是第129轮，那么用户提取收益的时候，只能提取[5,105)轮的收益，[105,129)轮的收益得再次发送提取收益的交易才能提取。这样设计也有另一层含义，用户可以尽可能地提取到至当前轮共识周期的前一轮的所有收益， 不提取当前轮收益是因为当前轮共识还未完成。

1. 确保用户质押过节点并且过去的几轮共识中有手续费收入；
2. 查询自用户上一次提取是的共识周期至当前轮的共识周期的节点质押状态；
3. 用户提取手续费收入；
4. 查询自用户上一次提取是的共识周期至当前轮的共识周期的节点质押状态；
5. 根据两次查询结果，以及用户的余额变化，可以对账；

### 预期

用户在每一轮提取到的收益的数量是正确的，提取到的总额是所有轮数提取数量的和。
注意Peer Owner和普通用户在收益计算上的不同。

## 其他反常case

1. 用户质押的节点退出共识；
2. 各种边界值；
3. 多分片情况时各个分片的嵌套手续费结算；
4. 节点退出再加入，用户再次质押这个节点；
5. 各种正常Case的自由组合。